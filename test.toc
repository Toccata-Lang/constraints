
;; regression tests for constraints.toc

(add-ns p (module "private.toc"))
(add-ns c (module "constraints.toc"))

(def coll-of-int (p/CollectionOf c/int-constraint empty-list p/no-symbol ""))
(def int-list (p/ListConstraint [] coll-of-int empty-list p/no-symbol ""))
(def int-list-1 (p/ListConstraint [c/int-constraint] p/no-tail empty-list p/no-symbol ""))
(def int-list-2 (p/ListConstraint [c/int-constraint c/int-constraint] p/no-tail empty-list p/no-symbol ""))
(def coll-of-int (p/CollectionOf c/int-constraint empty-list p/no-symbol ""))

(def int-vect (p/VectorConstraint [] coll-of-int empty-list p/no-symbol ""))
(def int-vect-1 (p/VectorConstraint [c/int-constraint] p/no-tail empty-list p/no-symbol ""))
(def int-vect-2 (p/VectorConstraint [c/int-constraint c/int-constraint] p/no-tail empty-list p/no-symbol ""))

(def sym-c (p/SymbolConstraint 'this-sym empty-list p/no-symbol ""))
(def coll-of-sym (p/CollectionOf c/sym-constraint empty-list p/no-symbol ""))

(def substr-c (p/SubStrConstraint "strng" empty-list p/no-symbol ""))
(def str-c (p/StrBuffConstraint "buffr" empty-list p/no-symbol ""))
(def coll-of-str (p/CollectionOf c/string-constraint empty-list p/no-symbol ""))

(def hash-coll-constraint (p/HashMapConstraint p/HashCollisionNodeType {}
                                               c/top-type c/top-type empty-list p/no-symbol ""))
(def array-constraint (p/HashMapConstraint p/ArrayNodeType {} c/top-type c/top-type empty-list p/no-symbol ""))
(def bitmap-constraint (p/HashMapConstraint p/BitmapIndexedType {} c/top-type c/top-type empty-list p/no-symbol ""))

(def pos-int (p/IntegerConstraint p/no-int int-max 1 empty-list p/no-symbol ""))
(def neg-int (p/IntegerConstraint p/no-int -1 int-min empty-list p/no-symbol ""))
(def pos-1 (p/IntegerConstraint 1 int-max int-min empty-list p/no-symbol ""))
(def pos-10 (p/IntegerConstraint 10 int-max int-min empty-list p/no-symbol ""))
(def neg-1 (p/IntegerConstraint -1 int-max int-min empty-list p/no-symbol ""))
(def neg-10 (p/IntegerConstraint -10 int-max int-min empty-list p/no-symbol ""))
(def int-0 (p/IntegerConstraint 0 int-max int-min empty-list p/no-symbol ""))
(def non-0 (p/SumConstraint [pos-int neg-int] empty-list p/no-symbol ""))

(def int-or-str (p/SumConstraint [c/int-constraint c/string-constraint] empty-list p/no-symbol ""))

(def maybe-str  (p/MaybeConstraint str-c empty-list p/no-symbol ""))
(def maybe-int  (p/MaybeConstraint pos-10 empty-list p/no-symbol ""))
(def maybe-sym  (p/MaybeConstraint sym-c empty-list p/no-symbol ""))

(def call-value (p/CallValue [str-c c/int-constraint] empty-list p/no-symbol ""))
(def param (p/ParamConstraint 'arity-1 0 empty-list p/no-symbol ""))
(def arg-of (p/ArgOf 'fn-sym 1 empty-list p/no-symbol ""))
(def result-of (p/CallValue p/no-args empty-list p/no-symbol ""))
(def first-of (p/FirstOf 'val-sym empty-list p/no-symbol ""))
(def last-of (p/LastOf 'val-sym empty-list p/no-symbol ""))
(def rest-of (p/RestOf 'val-sym empty-list p/no-symbol ""))
(def butlast-of (p/ButLastOf 'val-sym empty-list p/no-symbol ""))
(def list-from (p/ListFrom 'val-sym empty-list p/no-symbol ""))
(def vect-from (p/VectFrom 'val-sym empty-list p/no-symbol ""))
(def get-first (p/GetFrom [(.static-value c/int-constraint 0)]))
(def set-second (p/SetTo [(.static-value c/int-constraint 1)] non-0))

(def empty-reified (p/ReifiedConstraint 0 p/no-symbol {} {}
                                        (p/FnConstraint [] {} empty-list p/no-symbol "")
                                        empty-list  p/no-symbol ""))
(def reified-val (p/ReifiedConstraint
                  10 p/no-symbol {} {}
                  (p/FnConstraint [3]
                                  {3 (p/fn-arity 'arity-1
                                                 (p/ListConstraint [c/top-type c/top-type pos-int]
                                                                   p/no-tail empty-list p/no-symbol "")
                                                 param)}
                                  empty-list p/no-symbol "")
                  empty-list p/no-symbol ""))
(def reified-11 (p/ReifiedConstraint
                 11 p/no-symbol
                 {(p/Field 'field) c/top-type}
                 {(p/Field 'field) c/int-constraint}
                 (p/FnConstraint [] {} empty-list p/no-symbol "")
                 empty-list p/no-symbol ""))
(def reified-12 (p/ReifiedConstraint
                 12 p/no-symbol
                 {(p/Field 'other) c/string-constraint}
                 {(p/Field 'other) str-c}
                 (p/FnConstraint [] {} empty-list p/no-symbol "")
                 empty-list p/no-symbol ""))

(def test-constraints [c/top-type
                       c/bottom-type
                       c/empty-list-constraint
                       c/empty-vect-constraint
                       c/coll-of-any
                       c/list-constraint
                       c/vect-constraint
                       c/seq-constraint
                       c/fn-constraint
                       c/not-container
                       c/inner-type-of-constraint
                       c/substr-constraint
                       c/strbuff-constraint
                       c/string-constraint
                       c/seq-or-str-constraint
                       c/int-constraint
                       c/sym-constraint
                       c/maybe-constraint
                       c/agent-constraint
                       c/promise-constraint
                       c/future-constraint
                       c/opaque-constraint
                       c/arity-constraint
                       ;; c/hash-coll-constraint
                       ;; c/array-constraint
                       ;; c/bitmap-constraint
                       ;; c/hashmap-constraint
                       c/set-constraint

                       (p/ListConstraint [c/top-type pos-int] p/no-tail empty-list p/no-symbol "")
                       (p/VectorConstraint [sym-c pos-int] p/no-tail empty-list p/no-symbol "")

                       int-list
                       int-list-1
                       int-list-2
                       coll-of-int

                       int-vect
                       int-vect-1
                       int-vect-2

                       sym-c

                       substr-c
                       str-c
                       coll-of-str

                       pos-int
                       neg-int
                       pos-1
                       pos-10
                       neg-1
                       neg-10
                       int-0
                       non-0

                       maybe-str
                       maybe-int
                       maybe-sym

                       reified-val
                       reified-11
                       reified-12
                       empty-reified

                       first-of
                       last-of
                       rest-of
                       butlast-of
                       list-from
                       vect-from
                       get-first
                       set-second

                       arg-of
                       result-of
                       call-value
                       param])

(defprotocol MatchConstraint
  (exact-match [x y]
    (=* x y)))

(extend-type p/NoValues
  MatchConstraint
  (exact-match [x y]
    (and (=* x y)
         (or (empty? (.constraints x))
             (reduce (.constraints x) (first (.constraints x))
                     (fn [curr c]
                       (and curr
                            (some (.constraints y) (partial = c)))))))))

(defn test [ex1 ex2 file line]
  (either (exact-match ex1 ex2)
          (do
            (print-err 'Failed-at file line
                       "\nexpr 1" ex1
                       "\n\nexpr 2" ex2)
            (abort))))

(defn test-intersect [c1 c2]
  (let [final-1 (c/intersect c1 c2)
        ;; _ (print-err 'final-1 final-1)
        ;; _ (print-err "------")
        final-2 (c/intersect c2 c1)]
    ;; (print-err 'final-2 final-2)
    (either (map (= final-2 final-1)
                 (fn [c]
                   ;; (either (map (instance? c/NoValues c)
                   ;;              (fn [_]
                   ;;                (c/conflicting-assertions c _FILE_ _LINE_)
                   ;;                (print-err 'c c)))
                   ;;         (print-err 'final-c c))
                   final-1))
            (do
              (print-err "FAIL!! 'c/intersect not commutative")
              (print-err 'c1 c1)
              (print-err 'c2 c2)
              (print-err final-1)
              (print-err final-2)))))

(defn drop-until [coll pred]
  (cond (flat-map (first coll) pred)
        coll

        (drop-until (rest coll) pred)))

(def _ (test (c/trim (p/ListConstraint
                        [c/sym-constraint]
                        (p/ListConstraint [c/int-constraint] p/no-tail empty-list p/no-symbol "")
                        empty-list p/no-symbol ""))
             (p/ListConstraint [(p/SymbolConstraint p/no-symbol empty-list p/no-symbol "")
                                (p/IntegerConstraint p/no-int 2147483647 -2147483648 empty-list p/no-symbol "")]
                               p/no-tail empty-list p/no-symbol "")
             _FILE_ _LINE_))

(def _ (test (c/trim (p/ListConstraint
                        [c/int-constraint]
                        (p/ListConstraint [c/sym-constraint]
                                          (p/ListConstraint [c/int-constraint]
                                                            p/no-tail empty-list p/no-symbol "")
                                          empty-list p/no-symbol "")
                        empty-list p/no-symbol ""))
             (p/ListConstraint [(p/IntegerConstraint p/no-int 2147483647 -2147483648 empty-list p/no-symbol "")
                                (p/SymbolConstraint p/no-symbol empty-list p/no-symbol "")
                                (p/IntegerConstraint p/no-int 2147483647 -2147483648 empty-list p/no-symbol "")]
                               p/no-tail empty-list p/no-symbol "")
             _FILE_ _LINE_))

(def _ (test (c/derive (p/MaybeConstraint (c/intersect param c/int-constraint)
                                          empty-list p/no-symbol "")
                       maybe-str)
             (p/NoValues [(p/StrBuffConstraint "buffr" empty-list p/no-symbol "")
                          (p/IntegerConstraint p/no-int 2147483647 -2147483648 empty-list p/no-symbol "")])
             _FILE_ _LINE_))

(def _ (test (c/derive (-> param
                           (c/intersect c/maybe-constraint)
                           (c/intersect maybe-str))
                       c/top-type)
             maybe-str
             _FILE_ _LINE_))

(def _ (test (c/derive (-> param
                             (c/intersect c/maybe-constraint)
                             (c/intersect c/int-constraint)
                             (c/intersect maybe-str))
                         c/top-type)
             (p/NoValues [(p/IntegerConstraint p/no-int 2147483647 -2147483648 empty-list p/no-symbol "")
                          (p/MaybeConstraint p/top-type empty-list p/no-symbol "")])
             _FILE_ _LINE_))

(def _ (test (p/get-items c/top-type 3)
             [c/top-type c/top-type c/top-type]
             _FILE_ _LINE_))

(def _ (test (p/get-items coll-of-int 2)
             [c/int-constraint c/int-constraint]
             _FILE_ _LINE_))

(def _ (test (p/get-items (p/sum-type [coll-of-int
                                       int-list-1
                                       coll-of-sym])
                          2)
             [(p/SumConstraint
               [(p/IntegerConstraint p/no-int 2147483647 -2147483648 empty-list p/no-symbol "")
                (p/SymbolConstraint p/no-symbol empty-list p/no-symbol "")]
               empty-list p/no-symbol "")
              (p/SumConstraint
               [(p/IntegerConstraint p/no-int 2147483647 -2147483648 empty-list p/no-symbol "")
                (p/SymbolConstraint p/no-symbol empty-list p/no-symbol "")]
               empty-list p/no-symbol "")]
             _FILE_ _LINE_))

(def _ (test (p/get-items (p/sum-type [coll-of-int
                                       (p/ListConstraint []
                                                         (p/CollectionOf pos-int empty-list p/no-symbol "")
                                                         empty-list p/no-symbol "")
                                       coll-of-sym])
                          2)
             [(p/SumConstraint
               [(p/IntegerConstraint p/no-int 2147483647 -2147483648 empty-list p/no-symbol "")
                pos-int
                (p/SymbolConstraint p/no-symbol empty-list p/no-symbol "")]
               empty-list p/no-symbol "")
              (p/SumConstraint
               [(p/IntegerConstraint p/no-int 2147483647 -2147483648 empty-list p/no-symbol "")
                (p/SymbolConstraint p/no-symbol empty-list p/no-symbol "")
                pos-int]
               empty-list p/no-symbol "")]
             _FILE_ _LINE_))

(def _ (test (p/get-items int-list-1 2)
             []
             _FILE_ _LINE_))

(def _ (test (p/get-items int-vect-1 2)
             []
             _FILE_ _LINE_))

(def _ (test (p/get-items (p/sum-type [int-list-1
                                       (p/ListConstraint [c/sym-constraint] p/no-tail empty-list p/no-symbol "")])
                          2)
             []
             _FILE_ _LINE_))

(def _ (test (c/intersect int-list-1 c/coll-of-any)
             int-list-1
             _FILE_ _LINE_))

(def _ (test (c/intersect int-list-2
                          (p/ListConstraint [c/int-constraint c/sym-constraint]
                                            p/no-tail empty-list p/no-symbol ""))
             (p/NoValues [(p/SymbolConstraint p/no-symbol empty-list p/no-symbol "")
                          (p/IntegerConstraint p/no-int 2147483647 -2147483648 empty-list p/no-symbol "")])
             _FILE_ _LINE_))

(def _ (test (c/intersect int-vect-2
                          (p/VectorConstraint [c/int-constraint c/sym-constraint]
                                              p/no-tail empty-list p/no-symbol ""))
             (p/NoValues [(p/SymbolConstraint p/no-symbol empty-list p/no-symbol "")
                          (p/IntegerConstraint p/no-int 2147483647 -2147483648 empty-list p/no-symbol "")])
             _FILE_ _LINE_))

(def _ (test (c/intersect (p/AgentConstraint c/sym-constraint empty-list p/no-symbol "")
                          (p/AgentConstraint c/int-constraint empty-list p/no-symbol ""))
             (p/NoValues [(p/SymbolConstraint p/no-symbol empty-list p/no-symbol "")
                          (p/IntegerConstraint p/no-int 2147483647 -2147483648 empty-list p/no-symbol "")])
             _FILE_ _LINE_))

(def _ (test (c/intersect (p/PromiseConstraint c/sym-constraint empty-list p/no-symbol "")
                          (p/PromiseConstraint c/int-constraint empty-list p/no-symbol ""))
             (p/NoValues [(p/PromiseConstraint (p/SymbolConstraint p/no-symbol empty-list p/no-symbol "")
                                               empty-list p/no-symbol "")
                          (p/PromiseConstraint
                           (p/IntegerConstraint p/no-int 2147483647 -2147483648 empty-list p/no-symbol "")
                           empty-list p/no-symbol "")])
             _FILE_ _LINE_))

(def computed-bottom (p/ComputedConstraint [param
                                            c/int-constraint
                                            c/string-constraint]
                                           empty-list p/no-symbol ""))

(def _ (test (cata p/find-bottom computed-bottom)
             (p/NoValues [(p/IntegerConstraint p/no-int 2147483647 -2147483648 empty-list p/no-symbol "")
                          (p/StrBuffConstraint p/no-string empty-list p/no-symbol "")])
             _FILE_ _LINE_))

(def _ (test (cata p/find-bottom (.items c/list-constraint [computed-bottom]))
             (p/NoValues [(p/IntegerConstraint p/no-int 2147483647 -2147483648 empty-list p/no-symbol "")
                          (p/StrBuffConstraint p/no-string empty-list p/no-symbol "")])
             _FILE_ _LINE_))

(def _ (test (cata p/find-bottom (.tail-c c/vect-constraint computed-bottom))
             (p/NoValues [(p/IntegerConstraint p/no-int 2147483647 -2147483648 empty-list p/no-symbol "")
                          (p/StrBuffConstraint p/no-string empty-list p/no-symbol "")])
             _FILE_ _LINE_))

(def _ (test (cata p/find-bottom (.contents c/coll-of-any computed-bottom))
             (p/NoValues [(p/IntegerConstraint p/no-int 2147483647 -2147483648 empty-list p/no-symbol "")
                          (p/StrBuffConstraint p/no-string empty-list p/no-symbol "")])
             _FILE_ _LINE_))

(def _ (test (cata p/find-bottom (p/SumConstraint [computed-bottom]
                                                  empty-list p/no-symbol ""))
             (p/NoValues [(p/IntegerConstraint p/no-int 2147483647 -2147483648 empty-list p/no-symbol "")
                          (p/StrBuffConstraint p/no-string empty-list p/no-symbol "")])
             _FILE_ _LINE_))

(def _ (test (cata p/find-bottom (.arities c/fn-constraint
                                           {1 (p/fn-arity p/no-symbol
                                                          (.items c/list-constraint [computed-bottom])
                                                          c/int-constraint)}))
             (p/NoValues [(p/IntegerConstraint p/no-int 2147483647 -2147483648 empty-list p/no-symbol "")
                          (p/StrBuffConstraint p/no-string empty-list p/no-symbol "")])
             _FILE_ _LINE_))

(def _ (test (cata p/find-bottom (.arities c/fn-constraint
                                           {1 (p/fn-arity p/no-symbol
                                                          (.items c/list-constraint [c/int-constraint])
                                                          computed-bottom)}))
             (p/NoValues [(p/IntegerConstraint p/no-int 2147483647 -2147483648 empty-list p/no-symbol "")
                          (p/StrBuffConstraint p/no-string empty-list p/no-symbol "")])
             _FILE_ _LINE_))

(def _ (test (cata p/find-bottom
                   (.invoke-fn c/arity-constraint
                               (.arities c/fn-constraint
                                         {1 (p/fn-arity p/no-symbol
                                                        (.items c/list-constraint [computed-bottom])
                                                        c/int-constraint)})))
             (p/NoValues [(p/IntegerConstraint p/no-int 2147483647 -2147483648 empty-list p/no-symbol "")
                          (p/StrBuffConstraint p/no-string empty-list p/no-symbol "")])
             _FILE_ _LINE_))

(def _ (test (c/intersect c/fn-constraint
                          (p/FnConstraint [1]
                                          {1 (p/fn-arity p/no-symbol int-list-1 c/top-type)}
                                          empty-list p/no-symbol ""))
             (p/FnConstraint [1]
                             {1 (p/fn-arity p/no-symbol int-list-1 p/top-type)}
                             empty-list p/no-symbol "")
             _FILE_ _LINE_))

(def _ (test (c/intersect (p/FnConstraint [1]
                                          {1 (p/fn-arity p/no-symbol int-list-1 c/top-type)}
                                          empty-list p/no-symbol "")
                          (p/FnConstraint [1]
                                          {1 (p/fn-arity p/no-symbol
                                                         (p/ListConstraint [c/string-constraint]
                                                                           p/no-tail empty-list p/no-symbol "")
                                                         c/top-type)}
                                          empty-list p/no-symbol ""))
             (p/NoValues
              [(p/FnConstraint
                [1]
                {1 (p/fn-arity 'p/no-symbol
                               (p/ListConstraint
                                [(p/SumConstraint
                                  [(p/StrBuffConstraint p/no-string empty-list p/no-symbol "")

                                   (p/SubStrConstraint p/no-string empty-list p/no-symbol "")]
                                  empty-list p/no-symbol "")]
                                p/no-tail empty-list p/no-symbol "")
                               p/top-type)}
                empty-list p/no-symbol "")
               (p/FnConstraint
                [1]
                {1 (p/fn-arity 'p/no-symbol
                               (p/ListConstraint
                                [(p/IntegerConstraint p/no-int 2147483647 -2147483648 empty-list p/no-symbol "")]
                                p/no-tail empty-list p/no-symbol "")
                               p/top-type)}
                empty-list p/no-symbol "")])
             _FILE_ _LINE_))

(def _ (test (c/intersect (-> c/fn-constraint
                              (.required-arities [3])
                              (.arities (select-keys (.arities c/fn-constraint) [3])))
                          (p/FnConstraint [1]
                                          {1 (p/fn-arity p/no-symbol int-list-1 c/top-type)}
                                          empty-list p/no-symbol ""))
             (p/NoValues
              [(p/FnConstraint
                [1]
                {1 (p/fn-arity 'p/no-symbol
                               (p/ListConstraint
                                [(p/IntegerConstraint p/no-int 2147483647 -2147483648 empty-list p/no-symbol "")]
                                p/no-tail empty-list p/no-symbol "")
                               p/top-type)}
                empty-list p/no-symbol "")
               (p/FnConstraint
                [3]
                {3 (p/fn-arity 'p/no-symbol
                               (p/ListConstraint [p/top-type
                                                  p/top-type
                                                  p/top-type]
                                                 p/no-tail empty-list p/no-symbol "")
                               p/top-type)}
                empty-list p/no-symbol "")])
             _FILE_ _LINE_))

(def _ (test (c/intersect (p/FnConstraint []
                                          {1 (p/fn-arity p/no-symbol int-list-1 c/int-constraint)}
                                          empty-list p/no-symbol "")
                          (p/FnConstraint []
                                          {1 (p/fn-arity p/no-symbol int-list-1 c/sym-constraint)}
                                          empty-list p/no-symbol ""))
             (p/NoValues
              [(p/FnConstraint
                [] {1 (p/fn-arity
                       'p/no-symbol
                       (p/ListConstraint
                        [(p/IntegerConstraint p/no-int 2147483647 -2147483648 empty-list p/no-symbol "")]
                        p/no-tail empty-list p/no-symbol "")
                       (p/SymbolConstraint p/no-symbol empty-list p/no-symbol ""))}
                empty-list p/no-symbol "")
               (p/FnConstraint
                [] {1 (p/fn-arity 'p/no-symbol
                                  (p/ListConstraint
                                   [(p/IntegerConstraint p/no-int 2147483647 -2147483648 empty-list p/no-symbol "")]
                                   p/no-tail empty-list p/no-symbol "")
                                  (p/IntegerConstraint p/no-int 2147483647 -2147483648 empty-list p/no-symbol ""))}
                empty-list p/no-symbol "")])
             _FILE_ _LINE_))

(def _ (test (c/intersect (assoc-in reified-11 [.fields (p/Field 'field)] c/int-constraint)
                          (assoc-in reified-11 [.fields (p/Field 'field)] c/sym-constraint))
             (p/NoValues [(p/SymbolConstraint p/no-symbol empty-list p/no-symbol "")
                          (p/IntegerConstraint p/no-int 2147483647 -2147483648 empty-list p/no-symbol "")])
        _FILE_ _LINE_))

(def _ (test (c/intersect reified-val
                          arg-of)
             pos-int
        _FILE_ _LINE_))

(def _ (test (c/intersect arg-of
                          (p/SumConstraint
                           [reified-val
                            (p/FnConstraint []
                                            {2 (p/fn-arity p/no-symbol
                                                           (p/ListConstraint [c/top-type coll-of-sym]
                                                                             p/no-tail empty-list p/no-symbol "")
                                                           c/top-type)}
                                            empty-list p/no-symbol "")]
                           empty-list p/no-symbol ""))
             (p/SumConstraint [pos-int coll-of-sym] empty-list p/no-symbol "")
        _FILE_ _LINE_))

(def _ (test (c/intersect result-of
                          (p/SumConstraint
                           [(.invoke-fn reified-val
                                        (p/FnConstraint [1]
                                                        {1 (p/fn-arity p/no-symbol
                                                                       (p/ListConstraint [c/top-type] p/no-tail
                                                                                         empty-list p/no-symbol "")
                                                                       pos-int)}
                                                        empty-list p/no-symbol ""))
                            (p/FnConstraint []
                                            {2 (p/fn-arity p/no-symbol
                                                           (p/ListConstraint [c/top-type coll-of-sym]
                                                                             p/no-tail empty-list p/no-symbol "")
                                                           c/sym-constraint)}
                                            empty-list p/no-symbol "")]
                           empty-list p/no-symbol ""))
             (p/SumConstraint [pos-int c/sym-constraint] empty-list p/no-symbol "")
        _FILE_ _LINE_))

(def _ (test (c/intersect first-of c/empty-list-constraint)
             c/maybe-constraint
             _FILE_ _LINE_))

(def _ (test (c/intersect first-of int-list-1)
             maybe-int
             _FILE_ _LINE_))

(def _ (test (c/intersect int-vect-1 first-of)
             maybe-int
             _FILE_ _LINE_))

(def _ (test (c/intersect last-of c/empty-vect-constraint)
             c/maybe-constraint
             _FILE_ _LINE_))

(def _ (test (c/intersect last-of int-list-1)
             maybe-int
             _FILE_ _LINE_))

(def _ (test (c/intersect int-vect-1 last-of)
             maybe-int
             _FILE_ _LINE_))

(def _ (test (c/intersect rest-of c/empty-vect-constraint)
             c/empty-vect-constraint
             _FILE_ _LINE_))

(def _ (test (c/intersect rest-of int-list-1)
             c/empty-list-constraint
             _FILE_ _LINE_))

(def _ (test (c/intersect int-vect-2 rest-of)
             int-vect-1
             _FILE_ _LINE_))

(def _ (test (c/intersect (p/ListConstraint [c/int-constraint c/sym-constraint]
                                            p/no-tail empty-list p/no-symbol "")
                          butlast-of)
             int-list-1
             _FILE_ _LINE_))

(def _ (test (c/intersect int-vect-2
                          list-from)
             int-list-2
             _FILE_ _LINE_))

(def _ (test (c/intersect int-list-2
                          vect-from)
             int-vect-2
             _FILE_ _LINE_))

(def _ (test (c/intersect (p/CallValue [pos-int str-c] empty-list p/no-symbol "")
                          (p/FnConstraint [2]
                                          {2 (p/fn-arity 'arity-1 int-list-2
                                                         (c/intersect param
                                                                      c/int-constraint))}
                                          empty-list p/no-symbol ""))
             (p/NoValues [(p/IntegerConstraint p/no-int 2147483647 -2147483648 empty-list p/no-symbol "")
                          (p/StrBuffConstraint "buffr" empty-list p/no-symbol "")])
             _FILE_ _LINE_))

(def _ (test (c/intersect (p/CallValue [str-c c/int-constraint] empty-list p/no-symbol "")
                          reified-val)
             reified-val
             _FILE_ _LINE_))

(def _ (test (c/intersect (p/CallValue [str-c int-vect-2] empty-list p/no-symbol "")
                          reified-val)
             (p/NoValues [(p/IntegerConstraint p/no-int 2147483647 1 empty-list p/no-symbol "")
                          (p/VectorConstraint
                           [(p/IntegerConstraint p/no-int 2147483647 -2147483648 empty-list p/no-symbol "")
                            (p/IntegerConstraint p/no-int 2147483647 -2147483648 empty-list p/no-symbol "")]
                           p/no-tail empty-list p/no-symbol "")])
             _FILE_ _LINE_))

(def _ (test (c/intersect (p/CallValue [c/string-constraint] empty-list p/no-symbol "")
                          (p/FnConstraint []
                                          {1 (p/fn-arity 'arity-1
                                                         (p/ListConstraint [str-c]
                                                                           p/no-tail empty-list p/no-symbol "")
                                                         (p/ParamConstraint 'arity-1 0 empty-list p/no-symbol ""))}
                                          empty-list p/no-symbol ""))
             str-c
             _FILE_ _LINE_))

(def _ (test (c/intersect (p/CallValue [str-c] empty-list p/no-symbol "")
                          (.invoke-fn reified-val
                                      (p/FnConstraint
                                       [2]
                                       {2 (p/fn-arity 'arity-1
                                                      (p/ListConstraint [c/top-type pos-int]
                                                                        p/no-tail empty-list p/no-symbol "")
                                                      (p/ParamConstraint 'arity-1 1 empty-list p/no-symbol ""))}
                                       empty-list p/no-symbol "")))
             (p/NoValues [(p/IntegerConstraint p/no-int 2147483647 1 empty-list p/no-symbol "")
                          (p/StrBuffConstraint "buffr" empty-list p/no-symbol "")])
             _FILE_ _LINE_))

(def _ (test (c/intersect c/int-constraint
                          c/inner-type-of-constraint)
             (p/NoValues [(p/IntegerConstraint p/no-int 2147483647 -2147483648 empty-list p/no-symbol "")
                          empty-reified])
             _FILE_ _LINE_))

(def _ (test (c/intersect c/empty-list-constraint
                          c/inner-type-of-constraint)
             c/top-type
             _FILE_ _LINE_))

(def _ (test (c/intersect maybe-int
                          c/inner-type-of-constraint)
             c/int-constraint
             _FILE_ _LINE_))

(def _ (test (c/intersect (p/ListConstraint [c/top-type pos-int] p/no-tail empty-list p/no-symbol "")
                          c/inner-type-of-constraint)
             pos-int
             _FILE_ _LINE_))

(def _ (test (c/intersect (p/VectorConstraint [sym-c pos-int] p/no-tail empty-list p/no-symbol "")
                          c/inner-type-of-constraint)
             (p/sum-type [sym-c pos-int])
             _FILE_ _LINE_))

(def _ (test (c/intersect get-first
                          c/list-constraint)
             c/top-type
             _FILE_ _LINE_))

(def _ (test (c/intersect (p/GetFrom [(.static-value c/int-constraint 1)])
                          (p/ListConstraint [c/int-constraint pos-int]
                                            p/no-tail empty-list p/no-symbol ""))
             pos-int
             _FILE_ _LINE_))

(def _ (test (c/intersect (p/VectorConstraint [pos-int str-c] p/no-tail empty-list p/no-symbol "")
                          (p/GetFrom [(.static-value c/int-constraint 1)]))
             str-c
             _FILE_ _LINE_))

(def _ (test (c/intersect (assoc-in reified-11 [.fields (p/Field 'field)] pos-int)
                          (p/GetFrom [(p/Field 'field)]))
             pos-int
             _FILE_ _LINE_))

(def _ (test (c/intersect (p/GetFrom [(p/Field 'field)])
                          reified-11)
             c/int-constraint
             _FILE_ _LINE_))


(def _ (test (c/intersect (p/GetFrom [(p/Field 'field) (.static-value c/int-constraint 1)])
                          (assoc-in reified-11 [.fields (p/Field 'field)]
                                    (p/VectorConstraint [pos-int str-c] p/no-tail
                                                        empty-list p/no-symbol "")))
             str-c
             _FILE_ _LINE_))

(def _ (test (c/intersect (p/GetFrom [(.static-value c/int-constraint 1) (p/Field 'other)])
                          (p/VectorConstraint [pos-int
                                               (assoc-in reified-12 [.fields (p/Field 'other)] str-c)]
                                              p/no-tail empty-list p/no-symbol ""))
             str-c
             _FILE_ _LINE_))

(def _ (test (c/intersect (p/GetFrom [(.static-value c/int-constraint 1) (p/Field 'missing-field)])
                          (p/VectorConstraint [pos-int
                                               (assoc-in reified-12 [.fields (p/Field 'other)] str-c)]
                                              p/no-tail empty-list p/no-symbol ""))
             (p/NoValues
              [(assoc-in reified-12 [.fields (p/Field 'other)] str-c)
               empty-reified])
             _FILE_ _LINE_))

(def _ (test (c/intersect set-second
                          (p/ListConstraint [pos-int str-c]
                                            p/no-tail empty-list p/no-symbol ""))
             (c/intersect set-second
                          (p/ListConstraint [pos-int non-0]
                                            p/no-tail empty-list p/no-symbol ""))
             _FILE_ _LINE_))

(def _ (test (c/intersect (.items int-list [pos-int])
                          set-second)
             (.items int-list [pos-int non-0])
             _FILE_ _LINE_))

(def _ (test (c/intersect set-second
                          (p/ListConstraint [pos-int] p/no-tail empty-list p/no-symbol ""))
             (p/NoValues [(p/ListConstraint [pos-int] p/no-tail empty-list p/no-symbol "")
                          empty-reified])
             _FILE_ _LINE_))

(def _ (test (c/intersect (.items int-vect [pos-int])
                          set-second)
             (.items int-vect [pos-int non-0])
             _FILE_ _LINE_))

(def _ (test (c/intersect set-second
                          (p/VectorConstraint [pos-int] p/no-tail empty-list p/no-symbol ""))
             (p/NoValues [(p/VectorConstraint [pos-int] p/no-tail empty-list p/no-symbol "")
                          empty-reified])
             _FILE_ _LINE_))

(def _ (test (c/intersect (p/SetTo [(.static-value c/int-constraint 0)
                                    (.static-value c/int-constraint 0)]
                                   non-0)
                          (p/VectorConstraint [(p/ListConstraint [pos-int] p/no-tail empty-list p/no-symbol "")]
                                              p/no-tail empty-list p/no-symbol ""))
             (p/VectorConstraint [(p/ListConstraint [non-0] p/no-tail empty-list p/no-symbol "")]
                                 p/no-tail empty-list p/no-symbol "")
             _FILE_ _LINE_))

(def _ (test (c/intersect (p/SetTo [(.static-value c/int-constraint 0)
                                    (.static-value c/int-constraint 2)]
                                   non-0)
                          (p/VectorConstraint [(p/ListConstraint [pos-int] p/no-tail empty-list p/no-symbol "")]
                                              p/no-tail empty-list p/no-symbol ""))
             (p/NoValues [(p/ListConstraint [pos-int] p/no-tail empty-list p/no-symbol "")
                          empty-reified])
             _FILE_ _LINE_))

(def _ (test (c/intersect reified-11
                          (p/SetTo [(p/Field 'field)] pos-int))
             (assoc-in reified-11 [.fields (p/Field 'field)] pos-int) 
             _FILE_ _LINE_))

(def nested-reified (c/intersect reified-11 (p/SetTo [(p/Field 'field)] reified-12)))

(def _ (test nested-reified
             (assoc-in reified-11 [.fields (p/Field 'field)] reified-12) 
             _FILE_ _LINE_))

(def _ (test (c/intersect nested-reified
                          (p/SetTo [(p/Field 'field) (p/Field 'other)]
                                   substr-c))
             (assoc-in nested-reified [.fields (p/Field 'field) .fields (p/Field 'other)] substr-c) 
             _FILE_ _LINE_))

(def reified-vect (p/VectorConstraint [reified-12] p/no-tail empty-list p/no-symbol ""))
(def reified-list (p/ListConstraint [] (p/CollectionOf
                                        (c/intersect reified-11
                                                     (p/SetTo [(p/Field 'field)] reified-vect))
                                        empty-list p/no-symbol "")
                                    empty-list p/no-symbol ""))

(def _ (test (c/intersect reified-list
                          (p/SetTo [(.static-value c/int-constraint 1)
                                    (p/Field 'field)
                                    (.static-value c/int-constraint 0)
                                    (p/Field 'other)]
                                   substr-c))
             (p/ListConstraint
              [(p/ReifiedConstraint 11  (symbol "c/no-symbol")
                                    {(p/Field (symbol "field")) p/top-type}
                                    {(p/Field (symbol "field")) reified-vect}
                                    (p/FnConstraint [] {} empty-list p/no-symbol "")
                                    empty-list  p/no-symbol "")
               (p/ReifiedConstraint 11  (symbol "p/no-symbol")
                                    {(p/Field (symbol "field")) p/top-type}
                                    {(p/Field (symbol "field"))
                                     (p/VectorConstraint [(p/intersect reified-12
                                                                       (p/SetTo [(p/Field 'other)] substr-c))]
                                                         p/no-tail empty-list p/no-symbol "")}
                                    (p/FnConstraint [] {} empty-list p/no-symbol "")
                                    empty-list  p/no-symbol "")]
              (p/CollectionOf
               (p/ReifiedConstraint 11  (symbol "p/no-symbol")
                                    {(p/Field (symbol "field")) p/top-type}
                                    {(p/Field (symbol "field")) reified-vect}
                                    (p/FnConstraint [] {} empty-list p/no-symbol "")
                                    empty-list  p/no-symbol "")
               empty-list p/no-symbol "")
              empty-list p/no-symbol "")
             _FILE_ _LINE_))

(def _ (test (c/intersect reified-list
                          (p/SetTo [(.static-value c/int-constraint 1)
                                    (p/Field 'field)
                                    (.static-value c/int-constraint 0)
                                    (p/Field 'field)]
                                   substr-c))
             (p/NoValues [reified-12 empty-reified])
             _FILE_ _LINE_))

(def _ (test (c/intersect reified-list
                          (p/SetTo [(.static-value c/int-constraint 1)
                                    (p/Field 'field)
                                    (.static-value c/int-constraint 1)
                                    (p/Field 'other)]
                                   substr-c))
             (p/NoValues [reified-vect empty-reified])
             _FILE_ _LINE_))

(def _ (for [c1 test-constraints
             c2 (drop-until test-constraints (partial identical c1))
             c3 (drop-until test-constraints (partial identical c2))]
         (let [c12 (test-intersect c1 c2)
               c23 (test-intersect c2 c3)]
           (test-intersect c12 c23))))

(main [_]
  (print-err 'testing-constraints))
